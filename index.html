<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farm Feed Report Manager ‚Äî ITTIFAQ FEEDS</title>

  <!-- minimal reset + styles -->
  <style>
    :root { --blue:#007bff; --danger:#dc3545; --green:#28a745; --teal:#17a2b8; }
    body { font-family: Inter, system-ui, Arial, sans-serif; margin:20px; background:#f6f8fb; color:#222; }
    header { text-align:center; margin-bottom:18px; }
    header h1 { margin:0; font-size:22px; }
    .tabs { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
    .tablink { padding:8px 14px; border:0; background:#e6e9ee; border-radius:8px; cursor:pointer; font-weight:600; }
    .tablink.active { background:var(--blue); color:#fff; }
    .tabcontent { display:none; background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(10,20,40,0.06); }
    .tabcontent.active { display:block; }
    input[type=file] { padding:6px; }
    #fileList div { margin-top:8px; padding:8px; background:#f0f7ff; border-radius:6px; display:inline-block; }
    .report-controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .report-actions { margin-left:auto; display:flex; gap:8px; }
    button { cursor:pointer; border:0; border-radius:8px; padding:8px 12px; font-weight:600; }
    .print-btn { background:var(--green); color:white; }
    .backup-btn { background:var(--teal); color:white; }
    .add-btn { background:var(--blue); color:white; }
    .clear-btn { background:var(--danger); color:white; }

    #reportWrapper { overflow-x:auto; margin-top:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #d0d7df; padding:8px; text-align:center; }
    th { background:#f1f5f9; font-weight:700; }
    tr.total-row { font-weight:800; background:#fbfbfb; }
    tr.closed-row td { opacity:0.65; }
    .edit-btn, .remove-btn, .close-day-btn { padding:6px 8px; border-radius:6px; color:#fff; border:0; }
    .edit-btn { background:var(--blue); }
    .remove-btn { background:var(--danger); margin-left:6px; }
    .close-day-btn { background:#6c757d; }
    .disabled { opacity:0.5; pointer-events:none; }

    /* Modal */
    #overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9998; }
    #editModal { display:none; position:fixed; z-index:9999; left:50%; top:50%; transform:translate(-50%,-50%); width:360px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 12px 40px rgba(10,20,40,0.25); }
    #editModal h3 { margin:0 0 10px 0; }
    #editModal input { width:100%; padding:8px; margin-bottom:8px; border:1px solid #cfd8e3; border-radius:6px; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }

    /* Loading overlay */
    #loadingOverlay { display:none; position:fixed; inset:0; background:rgba(255,255,255,0.7); z-index:10000; text-align:center; padding-top:160px; }
    .spinner { border:6px solid #eee; border-top:6px solid var(--blue); width:44px; height:44px; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Print styles */
    @media print {
      body { margin:0; }
      .tabs, .report-controls, #editModal, #overlay, #loadingOverlay { display:none !important; }
      table { page-break-inside:auto; }
      tr { page-break-inside:avoid; page-break-after:auto; }
    }

    /* small responsive tweak */
    @media (max-width:520px) {
      #editModal { width:92%; }
      .report-actions { margin-left:0; width:100%; justify-content:space-between; }
    }

  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>üêÑ Farm Feed Report Manager</h1>
    <div style="font-size:12px;color:#666;margin-top:6px">Powered by <strong>ITTIFAQ FEEDS</strong></div>
  </header>

  <div class="tabs">
    <button class="tablink active" onclick="openTab(event,'uploadTab')">Upload</button>
    <button class="tablink" onclick="openTab(event,'reportTab')">Feed Report</button>
    <button class="tablink" onclick="openTab(event,'adminTab')">Admin</button>
  </div>

  <!-- Upload Tab -->
  <div id="uploadTab" class="tabcontent active">
    <h3>Upload JSON Reports</h3>
    <input id="fileInput" type="file" accept=".json" multiple />
    <div id="fileList" style="margin-top:10px"></div>
    <p style="color:#666;font-size:13px;margin-top:8px">Tip: upload JSON files where each file is an array of objects with fields: <code>date, farm, 333, 332, 331, 330, 313-B</code>.</p>
  </div>

  <!-- Report Tab -->
  <div id="reportTab" class="tabcontent">
    <h3>Feed Report Viewer / Editor</h3>

    <div class="report-controls">
      <label for="fileSelector">Select Report:</label>
      <select id="fileSelector" style="padding:8px;border-radius:6px;border:1px solid #cfd8e3"></select>

      <div class="report-actions">
        <button class="add-btn" id="addEntryBtn">+ Add Entry</button>
        <button class="print-btn" id="printBtn">Print Report</button>
        <button class="backup-btn" id="backupCurrentBtn">Backup (JSON)</button>
        <button class="backup-btn" id="csvBtn">Export CSV</button>
      </div>
    </div>

    <div id="reportWrapper">
      <table id="reportTable" style="display:none">
        <thead>
          <tr>
            <th>DATE</th>
            <th>FARM NAME</th>
            <th>333</th>
            <th>332</th>
            <th>331</th>
            <th>330</th>
            <th>313-B</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>

  <!-- Admin Tab -->
  <div id="adminTab" class="tabcontent">
    <h3>Admin</h3>
    <button id="clearBtn" class="clear-btn">Clear All Data</button>
  </div>

  <!-- Modal (used for Add & Edit) -->
  <div id="overlay"></div>
  <div id="editModal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Edit Entry</h3>
    <form id="editForm">
      <input id="editDate" placeholder="Date (YYYY-MM-DD)" required />
      <input id="editFarm" placeholder="Farm Name" required />
      <input id="edit333" placeholder="333" type="number" step="any" />
      <input id="edit332" placeholder="332" type="number" step="any" />
      <input id="edit331" placeholder="331" type="number" step="any" />
      <input id="edit330" placeholder="330" type="number" step="any" />
      <input id="edit313B" placeholder="313-B" type="number" step="any" />

      <div class="modal-actions">
        <button type="submit" id="saveBtn" class="add-btn">Save</button>
        <button type="button" onclick="closeModal()" style="background:#9aa3ad;color:#fff;padding:8px 12px;border-radius:8px">Cancel</button>
         <button onclick="reopenDay()">Reopen Day</button>
      </div>
    </form>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="color:#444;font-weight:600">Processing...</div>
  </div>

  <script>
const SUPABASE_URL = "https://kxrdehjguyeztfqhjfth.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cmRlaGpndXllenRmcWhqZnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NTE1ODQsImV4cCI6MjA3NTUyNzU4NH0.4ZJ0Dwrbzlcyqpobb7c3UyIrfHH-JfVW5Hy23M71LKo";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const FIELDS = ['333','332','331','330','313-B'];
let currentFiles = {};
let currentFileName = null;
let editIndex = null;
let isAddMode = false;

function showLoading(show){ document.getElementById('loadingOverlay').style.display = show?'block':'none'; }
function escapeHtml(s){ return String(s===undefined||s===null?'':s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }

function openTab(evt,id){
  document.querySelectorAll('.tabcontent').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tablink').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(evt&&evt.currentTarget) evt.currentTarget.classList.add('active');
}

// === Load initial data ===
window.addEventListener('DOMContentLoaded', async ()=>{
  showLoading(true);
  try {
    const {data,error} = await supabase.from('feed_reports').select('*');
    if(error) console.error(error);
    if(data) data.forEach(r=> currentFiles[r.filename]=r.data||[]);
  }catch(e){console.error(e);}
  updateFileList();
  updateFileSelector();
  showLoading(false);
});

// === Upload JSON ===
document.getElementById('fileInput').addEventListener('change', async e=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  showLoading(true);
  for(const f of files){
    try{
      const text = await f.text();
      const json = JSON.parse(text);
      if(!Array.isArray(json)){alert(`File ${f.name} must contain an array.`);continue;}
      currentFiles[f.name]=json;
      await supabase.from('feed_reports').upsert([{filename:f.name,data:json}]);
    }catch(err){alert(`Error in ${f.name}: ${err}`);}
  }
  updateFileList();
  updateFileSelector();
  openTab({currentTarget:document.querySelector('.tablink:nth-child(2)')},'reportTab');
  showLoading(false);
});

function updateFileList(){
  const div=document.getElementById('fileList');
  const names=Object.keys(currentFiles);
  div.innerHTML=names.length?names.map(n=>`<div>${escapeHtml(n)}</div>`).join(''):'<div style="color:#666">No files loaded</div>';
}

function updateFileSelector(){
  const sel=document.getElementById('fileSelector');
  const names=Object.keys(currentFiles);
  sel.innerHTML=names.length?names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join(''):'<option>-- No files --</option>';
  if(names.length){currentFileName=names[0];sel.value=currentFileName;loadReport(currentFileName);}
  else{document.getElementById('reportTable').style.display='none';}
}
document.getElementById('fileSelector').addEventListener('change',e=>{
  currentFileName=e.target.value;
  if(currentFileName)loadReport(currentFileName);
});

// === Render ===
function loadReport(fn){currentFileName=fn;renderReport(currentFiles[fn]||[]);}

function renderReport(data){
  const table=document.getElementById('reportTable');
  while(table.tBodies.length)table.removeChild(table.tBodies[0]);
  if(!data.length){table.style.display='none';return;}

  const groups={};
  data.forEach((r,i)=>{const d=r.date||'Unknown';(groups[d]||(groups[d]=[])).push({...r,_index:i});});

  Object.keys(groups).sort().forEach(date=>{
    const tb=document.createElement('tbody');
    const totals=FIELDS.reduce((a,f)=>(a[f]=0,a),{});
    const closed=groups[date].every(e=>e.closed);

    groups[date].forEach(r=>{
      const tr=document.createElement('tr');
      if(r.closed)tr.classList.add('closed-row');
      let html=`<td>${escapeHtml(r.date||'')}</td><td>${escapeHtml(r.farm||'')}</td>`;
      FIELDS.forEach(f=>{const v=r[f];if(v)totals[f]+=parseFloat(v)||0;html+=`<td>${escapeHtml(v||'')}</td>`;});
      const dis=r.closed?'disabled':'';
      html+=`<td><button class="edit-btn" ${dis} onclick="editEntry(${r._index})">Edit</button>
                 <button class="remove-btn" ${dis} onclick="removeEntry(${r._index})">Remove</button></td>`;
      tr.innerHTML=html;
      tb.appendChild(tr);
    });

    const totalTr=document.createElement('tr');
    totalTr.className='total-row';
    let totalCells=`<td colspan="2">TOTAL (${escapeHtml(date)})</td>`;
    FIELDS.forEach(f=>totalCells+=`<td>${totals[f]}</td>`);
    totalCells+=closed
      ? `<td><button class="close-day-btn" onclick="reopenDay('${escapeHtml(date)}')">Reopen Day</button></td>`
      : `<td><button class="close-day-btn" onclick="closeDay('${escapeHtml(date)}')">Close Day</button></td>`;
    totalTr.innerHTML=totalCells;
    tb.appendChild(totalTr);
    table.appendChild(tb);
  });
  table.style.display='table';
}

// === Reopen Day ===
async function reopenDay(date){
  if(!currentFileName)return alert('No file selected');
  const pass=prompt('Enter admin password to reopen day:');
  if(pass!=='123')return alert('Incorrect password.');
  if(!confirm(`Reopen all entries for ${date}?`))return;

  const data=currentFiles[currentFileName];
  let changed=false;
  data.forEach(e=>{if((e.date||'')===date && e.closed){e.closed=false;changed=true;}});
  if(!changed)return alert('No closed entries found.');

  showLoading(true);
  try{
    await supabase.from('feed_reports').update({data}).eq('filename',currentFileName);
    renderReport(data);
    alert('Day reopened. Entries are now editable.');
  }catch(err){console.error(err);alert('Error reopening day.');}
  showLoading(false);
}

// === Edit / Add ===
document.getElementById('addEntryBtn').onclick=()=>{
  if(!currentFileName)return alert('No report selected.');
  isAddMode=true;editIndex=null;
  document.getElementById('modalTitle').textContent='Add Entry';
  document.getElementById('saveBtn').textContent='Add';
  const today=new Date().toISOString().slice(0,10);
  ['Date','Farm','333','332','331','330','313B'].forEach(id=>document.getElementById('edit'+id).value='');
  document.getElementById('editDate').value=today;
  document.getElementById('overlay').style.display='block';
  document.getElementById('editModal').style.display='block';
};

function editEntry(i){
  if(!currentFileName)return alert('No file');
  const pass=prompt('Enter admin password:');if(pass!=='123')return alert('Incorrect password.');
  const data=currentFiles[currentFileName];
  const e=data[i];if(!e)return alert('Not found');if(e.closed)return alert('Closed entry');
  isAddMode=false;editIndex=i;
  document.getElementById('modalTitle').textContent='Edit Entry';
  document.getElementById('saveBtn').textContent='Save';
  document.getElementById('editDate').value=e.date||'';
  document.getElementById('editFarm').value=e.farm||'';
  document.getElementById('edit333').value=e['333']||'';
  document.getElementById('edit332').value=e['332']||'';
  document.getElementById('edit331').value=e['331']||'';
  document.getElementById('edit330').value=e['330']||'';
  document.getElementById('edit313B').value=e['313-B']||'';
  document.getElementById('overlay').style.display='block';
  document.getElementById('editModal').style.display='block';
}

function closeModal(){
  document.getElementById('overlay').style.display='none';
  document.getElementById('editModal').style.display='none';
}

document.getElementById('editForm').onsubmit=async e=>{
  e.preventDefault();
  if(!currentFileName)return;
  const pass=prompt('Enter admin password:');if(pass!=='123')return alert('Incorrect password.');
  const obj={
    date:editDate.value.trim(),
    farm:editFarm.value.trim(),
    '333':edit333.value.trim(),
    '332':edit332.value.trim(),
    '331':edit331.value.trim(),
    '330':edit330.value.trim(),
    '313-B':edit313B.value.trim(),
    closed:false
  };
  showLoading(true);
  try{
    if(isAddMode)currentFiles[currentFileName].push(obj);
    else Object.assign(currentFiles[currentFileName][editIndex],obj);
    await supabase.from('feed_reports').update({data:currentFiles[currentFileName]}).eq('filename',currentFileName);
    renderReport(currentFiles[currentFileName]);
  }catch(err){alert('Error saving');console.error(err);}
  showLoading(false);
  closeModal();
};

// === Remove ===
async function removeEntry(i){
  if(!currentFileName)return;
  const pass=prompt('Enter admin password:');if(pass!=='123')return alert('Incorrect password.');
  if(!confirm('Delete entry?'))return;
  const d=currentFiles[currentFileName];
  if(d[i].closed)return alert('Closed entry');
  d.splice(i,1);
  showLoading(true);
  await supabase.from('feed_reports').update({data:d}).eq('filename',currentFileName);
  renderReport(d);
  showLoading(false);
}

// === Close Day ===
async function closeDay(date){
  if(!currentFileName)return;
  const pass=prompt('Enter admin password:');if(pass!=='123')return alert('Incorrect password.');
  if(!confirm(`Close entries for ${date}?`))return;
  const d=currentFiles[currentFileName];
  let changed=false;
  d.forEach(e=>{if((e.date||'')===date && !e.closed){e.closed=true;changed=true;}});
  if(!changed)return alert('Nothing to close');
  showLoading(true);
  await supabase.from('feed_reports').update({data:d}).eq('filename',currentFileName);
  renderReport(d);
  showLoading(false);
  alert('Day closed.');
}

// === Backup ===
document.getElementById('backupCurrentBtn').onclick=()=>{
  if(!currentFileName)return alert('No file');
  const d=currentFiles[currentFileName];
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${currentFileName.replace(/\.[^/.]+$/,'')}-backup.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// === CSV Export ===
document.getElementById('csvBtn').onclick=()=>{
  if(!currentFileName)return;
  const d=currentFiles[currentFileName];
  if(!d.length)return alert('No data');
  const rows=[['DATE','FARM','333','332','331','330','313-B','STATUS']];
  const groups={};
  d.forEach(r=>{(groups[r.date]||(groups[r.date]=[])).push(r);});
  Object.keys(groups).forEach(date=>{
    groups[date].forEach(r=>rows.push([r.date,r.farm,r['333'],r['332'],r['331'],r['330'],r['313-B'],r.closed?'CLOSED':'OPEN']));
  });
  const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${currentFileName}-export.csv`;
  a.click();URL.revokeObjectURL(a.href);
};

// === Print ===
document.getElementById('printBtn').onclick=()=>{
  if(!currentFileName)return;
  const d=currentFiles[currentFileName];
  if(!d.length)return;
  const html=generatePrintHTML(d,currentFileName);
  const w=window.open('','_blank','width=900,height=700');
  w.document.write(html);w.document.close();setTimeout(()=>{w.print();},400);
};

function generatePrintHTML(data,filename){
  const groups={};
  data.forEach(r=>{(groups[r.date]||(groups[r.date]=[])).push(r);});
  const body=Object.keys(groups).sort().map(date=>{
    const rows=groups[date].map(r=>`<tr><td>${r.date}</td><td>${r.farm}</td><td>${r['333']}</td><td>${r['332']}</td><td>${r['331']}</td><td>${r['330']}</td><td>${r['313-B']}</td><td>${r.closed?'CLOSED':'OPEN'}</td></tr>`).join('');
    const totals=FIELDS.map(f=>groups[date].reduce((s,e)=>s+(parseFloat(e[f])||0),0));
    const totalRow=`<tr style="font-weight:700;background:#f3f3f3"><td colspan="2">TOTAL (${date})</td>${totals.map(t=>`<td>${t}</td>`).join('')}<td>-</td></tr>`;
    return `<tbody>${rows}${totalRow}</tbody>`;
  }).join('');
  return `<!doctype html><html><head><meta charset="utf-8"><title>${filename}</title>
  <style>body{font-family:Arial;padding:18px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #bbb;padding:6px;text-align:center;font-size:12px;}th{background:#eee;}</style>
  </head><body>
  <div style="text-align:center;font-weight:700;font-size:18px">ITTIFAQ FEEDS</div>
  <div style="text-align:center;margin-top:4px;font-size:13px">Feed Report ‚Äî ${filename}</div>
  <table><thead><tr><th>DATE</th><th>FARM</th><th>333</th><th>332</th><th>331</th><th>330</th><th>313-B</th><th>STATUS</th></tr></thead>${body}</table>
  <div style="text-align:center;margin-top:12px;font-size:12px;color:#555">System developed by Aoun Ahmed</div>
  </body></html>`;
}

// === Clear All ===
document.getElementById('clearBtn').onclick=async()=>{
  const pass=prompt('Enter admin password:');if(pass!=='123')return;
  if(!confirm('Clear all data?'))return;
  showLoading(true);
  await supabase.from('feed_reports').delete().neq('filename','');
  currentFiles={};
  updateFileList();updateFileSelector();
  showLoading(false);
  alert('All data cleared.');
};

// expose
window.editEntry=editEntry;
window.removeEntry=removeEntry;
window.closeDay=closeDay;
window.reopenDay=reopenDay;
</script>
</body>
</html>
