<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ittifaq Feeds — Manager (Supabase)</title>
  <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#6b7280;--accent:#0f62fe}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Arial;margin:0;background:var(--bg);color:#111}
    header{background:linear-gradient(90deg,#0f62fe22,#06b6d422);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .card{background:var(--card);margin:16px auto;max-width:1200px;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(12,12,12,0.06)}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(15,98,254,0.12)}
    input[type=file]{display:none}
    .row{display:flex;gap:12px;align-items:center}
    .report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .report-title{font-weight:700;font-size:16px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px 6px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    th{background:#fafafa;position:sticky;top:0}
    .group{background:#fff;border-radius:8px;padding:10px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.03)}
    .group-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .group-totals{font-weight:600}
    .tiny{font-size:12px;color:var(--muted)}
    .actions button{margin-right:6px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(11,12,15,0.45);display:none;align-items:center;justify-content:center;padding:12px}
    .modal{background:var(--card);width:660px;max-width:100%;padding:16px;border-radius:10px}
    .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    label{font-size:13px}
    input[type=text],input[type=date],input[type=number],select{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e6e6}
    .danger{background:#ef4444}
    .gap-small{height:8px}
    @media (max-width:820px){ .form-grid{grid-template-columns:1fr} }
    #loginModal .modal{width:360px}
    .disabled{opacity:0.5;pointer-events:none}
  </style>
</head>
<body>
  <header>
    <h1>Ittifaq Feeds Manager</h1>
    <div class="controls">
      <div class="tiny">Logged as: <span id="currentUser">Not logged</span></div>
      <button id="loginBtn" class="ghost">Login</button>
      <button id="logoutBtn" class="ghost" style="display:none">Logout</button>
    </div>
  </header>

  <main class="card" id="app">
    <div class="report-header">
      <div>
        <div class="report-title">Ittifaq Feeds Report</div>
        <div id="reportDate" class="tiny">Report Generated on -</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="ghost" id="uploadLabel" style="padding:8px 10px;border-radius:8px;border:1px dashed #e2e8f0;cursor:pointer">
          <input id="fileInput" type="file" accept="application/json"/>
          Upload JSON
        </label>
        <button id="exportBtn" class="ghost">Export JSON</button>
        <button id="pdfBtn" class="ghost">Download PDF</button>
        <button id="cloudSaveBtn" class="ghost">Save to Cloud</button>
        <button id="addBtn">Add Entry</button>
      </div>
    </div>

    <div id="tableArea"></div>
    <div id="empty" class="muted tiny" style="margin-top:18px">No data loaded. Upload a JSON file or add entries.</div>
  </main>

  <footer style="max-width:1200px;margin:12px auto;display:flex;justify-content:space-between;color:var(--muted)">
    <div class="tiny">Dates display as "08 Oct 2025". JSON export uses same format. Grouped by date with per-group totals.</div>
    <div class="tiny">Admin can delete and upload JSON; employees cannot replace uploaded JSON.</div>
  </footer>

  <!-- Login modal -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <h3>Login</h3>
      <div style="margin-top:8px">
        <label>User ID</label>
        <input id="loginId" type="text"/>
        <div class="gap-small"></div>
        <label>Password</label>
        <input id="loginPass" type="password"/>
        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
          <button id="loginCancel" class="ghost">Cancel</button>
          <button id="loginSubmit">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Entry modal -->
  <div id="modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <h3 id="modalTitle">Add / Edit Entry</h3>
      <form id="entryForm">
        <div class="form-grid" style="margin-top:8px">
          <div>
            <label>Date</label>
            <input type="date" id="fDateNative"/>
            <input type="text" id="fDate" placeholder="08 Oct 2025" required/>
          </div>
          <div>
            <label>Farm</label>
            <input type="text" id="fFarm" required/>
          </div>
          <div>
            <label>333</label><input type="number" id="f333" min="0" step="1"/>
          </div>
          <div>
            <label>332</label><input type="number" id="f332" min="0" step="1"/>
          </div>
          <div>
            <label>3331</label><input type="number" id="f3331" min="0" step="1"/>
          </div>
          <div>
            <label>330</label><input type="number" id="f330" min="0" step="1"/>
          </div>
          <div>
            <label>313-A</label><input type="number" id="f313A" min="0" step="1"/>
          </div>
          <div>
            <label>313-B</label><input type="number" id="f313B" min="0" step="1"/>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
          <button type="button" id="cancelBtn" class="ghost">Cancel</button>
          <button type="submit" id="saveEntry">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  /*********************************************************
   * Config - put real values if you want cloud enabled
   *********************************************************/
  const SUPABASE_URL = 'https://zxiastbukdpplukpvnas.supabase.co'; // <-- replace
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4aWFzdGJ1a2RwcGx1a3B2bmFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NTg1NTMsImV4cCI6MjA3NTUzNDU1M30.GqkeYMjcNTxkSj-B5nScGQlqFFZTQWELWSCPz9lwgDU';               // <-- replace
  const supabase = (window.supabase && window.supabase.createClient) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
  /*********************************************************/

  // App state
  let state = { data: [], user: null, uploadedByAdmin: false };
  let editIndex = null;

  // credentials
  const CREDENTIALS = {
    admin: { id: 'admin22', pass: '12345', role: 'admin' },
    employee: { id: 'user22', pass: '23456', role: 'employee' }
  };

  // elements
  const currentUserDom = document.getElementById('currentUser');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginModal = document.getElementById('loginModal');
  const loginSubmit = document.getElementById('loginSubmit');
  const loginCancel = document.getElementById('loginCancel');
  const loginId = document.getElementById('loginId');
  const loginPass = document.getElementById('loginPass');

  const fileInput = document.getElementById('fileInput');
  const uploadLabel = document.getElementById('uploadLabel');
  const exportBtn = document.getElementById('exportBtn');
  const pdfBtn = document.getElementById('pdfBtn');
  const cloudSaveBtn = document.getElementById('cloudSaveBtn');
  const addBtn = document.getElementById('addBtn');

  const tableArea = document.getElementById('tableArea');
  const empty = document.getElementById('empty');
  const reportDateDom = document.getElementById('reportDate');

  const modal = document.getElementById('modal');
  const entryForm = document.getElementById('entryForm');
  const cancelBtn = document.getElementById('cancelBtn');

  // fields
  const fDateNative = document.getElementById('fDateNative');
  const fDate = document.getElementById('fDate');
  const fFarm = document.getElementById('fFarm');
  const f333 = document.getElementById('f333');
  const f332 = document.getElementById('f332');
  const f3331 = document.getElementById('f3331');
  const f330 = document.getElementById('f330');
  const f313A = document.getElementById('f313A');
  const f313B = document.getElementById('f313B');

  // date helpers
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function pad(n){ return n<10?('0'+n):String(n); }
  function isoToDisplay(iso){ if(!iso) return ''; const d=new Date(iso); if(isNaN(d)) return ''; return pad(d.getDate())+' '+monthNames[d.getMonth()]+' '+d.getFullYear(); }
  function parseAnyToDisplay(s){
    if(!s) return '';
    if(/^[0-3]\d\s+[A-Za-z]{3}\s+\d{4}$/.test(s)) return s;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return isoToDisplay(s);
    const m = s.match(/^(\d{1,2})[-\/]?(\d{1,2})[-\/]?(\d{4})$/);
    if(m){ const day=Number(m[1]), mon=Number(m[2])-1, yr=Number(m[3]); if(mon>=0&&mon<12) return pad(day)+' '+monthNames[mon]+' '+yr; }
    const d=new Date(s); if(!isNaN(d)) return pad(d.getDate())+' '+monthNames[d.getMonth()]+' '+d.getFullYear();
    return '';
  }
  function displayToISO(display){
    const m = display.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})$/);
    if(m){ const day=Number(m[1]), mon=monthNames.indexOf(m[2]), yr=Number(m[3]); if(mon>=0) return `${yr}-${String(mon+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; }
    if(/^\d{4}-\d{2}-\d{2}$/.test(display)) return display;
    return null;
  }

  // wire date inputs
  fDateNative.addEventListener('change', ()=> fDate.value = isoToDisplay(fDateNative.value));
  fDate.addEventListener('input', ()=> { const iso = displayToISO(fDate.value); if(iso) fDateNative.value = iso; });

  // login logic
  loginBtn.addEventListener('click', ()=>{ loginModal.style.display='flex'; loginId.value=''; loginPass.value=''; });
  loginCancel.addEventListener('click', ()=>{ loginModal.style.display='none'; });
  loginSubmit.addEventListener('click', ()=> {
    const id = (loginId.value||'').trim(), pass = (loginPass.value||'').trim();
    if(!id || !pass) return alert('Enter id & password');
    if(id===CREDENTIALS.admin.id && pass===CREDENTIALS.admin.pass){
      setUser({ id: id, role: 'admin' });
    } else if(id===CREDENTIALS.employee.id && pass===CREDENTIALS.employee.pass){
      setUser({ id: id, role: 'employee' });
    } else {
      return alert('Invalid credentials');
    }
    loginModal.style.display='none';
  });
  logoutBtn.addEventListener('click', ()=> setUser(null));

  function setUser(u){
    state.user = u;
    if(u){
      currentUserDom.textContent = `${u.id} (${u.role})`;
      loginBtn.style.display='none';
      logoutBtn.style.display='inline-block';
    } else {
      currentUserDom.textContent = 'Not logged';
      loginBtn.style.display='inline-block';
      logoutBtn.style.display='none';
    }
    refreshControls();
  }

  function refreshControls(){
    // Upload enabled only when logged in as admin and dataset hasn't been locked by an earlier admin upload (or admin can re-upload)
    if(state.user && state.user.role==='admin'){
      uploadLabel.classList.remove('disabled');
    } else {
      uploadLabel.classList.add('disabled');
    }
  }

  // file upload (admin only)
  fileInput.addEventListener('change', e=>{
    if(!state.user || state.user.role !== 'admin'){
      alert('Only admin can upload JSON files.');
      fileInput.value = '';
      return;
    }
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        if(!Array.isArray(parsed)) throw new Error('JSON must be an array');
        const out = parsed.map(r=>({
          Date: parseAnyToDisplay(r.Date || r.date || r.D || ''),
          Farm: String(r.Farm || r.farm || r.F || '').trim(),
          '333': numOrNull(r['333']),
          '332': numOrNull(r['332']),
          '3331': numOrNull(r['3331']),
          '330': numOrNull(r['330']),
          '313-A': numOrNull(r['313-A']||r['313A']),
          '313-B': numOrNull(r['313-B']||r['313B'])
        }));
        state.data = out;
        state.uploadedByAdmin = true;
        saveLocal();
        render();
        alert('JSON loaded. Uploaded dataset is admin-controlled.');
      } catch(err){
        alert('Invalid JSON: '+err.message);
      }
    };
    reader.readAsText(f);
    fileInput.value = '';
  });

  function numOrNull(v){ if(v===null||v===undefined||v==='') return null; const n=Number(v); return isNaN(n)?null:n; }

  // add / edit handlers
  addBtn.addEventListener('click', ()=> openModalForAdd());
  cancelBtn.addEventListener('click', ()=> { modal.style.display='none'; editIndex=null; });

  function openModalForAdd(){
    editIndex = null;
    document.getElementById('modalTitle').textContent='Add Entry';
    const now=new Date(); fDateNative.value = now.toISOString().slice(0,10); fDate.value = isoToDisplay(fDateNative.value);
    fFarm.value=''; f333.value=f332.value=f3331.value=f330.value=f313A.value=f313B.value='';
    modal.style.display='flex';
  }

  function openModalForEdit(idx){
    editIndex = idx;
    document.getElementById('modalTitle').textContent='Edit Entry';
    const e = state.data[idx];
    fDate.value = e.Date || ''; const iso = displayToISO(e.Date||''); fDateNative.value = iso||'';
    fFarm.value = e.Farm||'';
    f333.value = e['333'] ?? '';
    f332.value = e['332'] ?? '';
    f3331.value = e['3331'] ?? '';
    f330.value = e['330'] ?? '';
    f313A.value = e['313-A'] ?? '';
    f313B.value = e['313-B'] ?? '';
    modal.style.display='flex';
  }

  entryForm.addEventListener('submit', e=>{
    e.preventDefault();
    const dateDisplay = fDate.value || isoToDisplay(fDateNative.value);
    const entry = {
      Date: parseAnyToDisplay(dateDisplay),
      Farm: (fFarm.value||'').trim(),
      '333': numOrNull(f333.value),
      '332': numOrNull(f332.value),
      '3331': numOrNull(f3331.value),
      '330': numOrNull(f330.value),
      '313-A': numOrNull(f313A.value),
      '313-B': numOrNull(f313B.value)
    };
    if(!entry.Date){ return alert('Please provide a valid date'); }
    if(editIndex===null){
      const idx = state.data.findIndex(r=>r.Date===entry.Date && r.Farm===entry.Farm);
      if(idx!==-1){
        ['333','332','3331','330','313-A','313-B'].forEach(k=>{ state.data[idx][k] = (state.data[idx][k]||0) + (entry[k]||0); });
      } else state.data.push(entry);
    } else {
      state.data[editIndex] = entry;
    }
    saveLocal(); modal.style.display='none'; editIndex=null; render();
  });

  // export JSON
  exportBtn.addEventListener('click', ()=>{
    const out = state.data.map(r=>({
      Date: r.Date,
      Farm: r.Farm,
      '333': r['333']||null,
      '332': r['332']||null,
      '3331': r['3331']||null,
      '330': r['330']||null,
      '313-A': r['313-A']||null,
      '313-B': r['313-B']||null
    }));
    const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='report.json'; a.click(); URL.revokeObjectURL(url);
  });

  // PDF
  pdfBtn.addEventListener('click', downloadPDF);
  async function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
    const now=new Date();
    const reportDateStr = pad(now.getDate())+' '+monthNames[now.getMonth()]+' '+now.getFullYear();
    pdf.setFontSize(16); pdf.text('Ittifaq Feeds Report', 40, 60);
    pdf.setFontSize(10); pdf.text('Report Generated on ' + reportDateStr, 40, 78);

    const headers = ['Date','Farm','333','332','3331','330','313-A','313-B'];
    let y = 110; const startX = 40; const colWidths = [80,140,50,50,50,50,60,60];
    pdf.setFontSize(9);
    let x = startX;
    headers.forEach((h,idx)=>{ pdf.text(h, x+2, y); x+=colWidths[idx]; });
    y+=16;

    const groups = groupByDate(state.data);
    for(const dt of Object.keys(groups).sort((a,b)=>dateToTimestamp(a)-dateToTimestamp(b))){
      const rows = groups[dt];
      pdf.setFontSize(10); pdf.text(dt, startX, y); y+=14;
      pdf.setFontSize(9);
      rows.forEach(r=>{
        x = startX;
        const cells = [r.Date, r.Farm, r['333']||'', r['332']||'', r['3331']||'', r['330']||'', r['313-A']||'', r['313-B']||''];
        cells.forEach((c,idx)=>{pdf.text(String(c||''), x+2, y); x+=colWidths[idx];});
        y+=14;
        if(y>750){ pdf.addPage(); y=40; }
      });
      const tot = groupTotals(rows);
      x = startX; pdf.setFontSize(9); pdf.text('Group totals:', x+2, y);
      x += colWidths[0]+colWidths[1];
      ['333','332','3331','330','313-A','313-B'].forEach((k,idx)=>{ pdf.text(String(tot[k]||''), x+2, y); x+=colWidths[idx+2]; });
      y+=18;
      if(y>700){ pdf.addPage(); y=40; }
    }

    const grand = computeTotals();
    pdf.setFontSize(11); pdf.text('Grand Totals:', startX, y);
    x = startX + colWidths[0] + colWidths[1];
    ['333','332','3331','330','313-A','313-B'].forEach((k,idx)=>{ pdf.text(String(grand[k]||''), x+2, y); x+=colWidths[idx+2]; });
    const filename = `FeedReport_${pad(now.getDate())}-${monthNames[now.getMonth()]}-${now.getFullYear()}.pdf`;
    pdf.save(filename);
  }

  // Cloud save (requires valid SUPABASE_URL & KEY)
  cloudSaveBtn.addEventListener('click', async ()=>{
    if(!supabase) return alert('Configure SUPABASE_URL and SUPABASE_ANON_KEY at top of file to enable cloud save.');
    if(!state.user) return alert('Please login first to save to cloud.');
    if(!state.data.length) return alert('No data to save.');

    const rows = state.data.map(r=>({
      report_date: r.Date,
      farm: r.Farm,
      val_333: r['333'] || null,
      val_332: r['332'] || null,
      val_3331: r['3331'] || null,
      val_330: r['330'] || null,
      val_313_a: r['313-A'] || null,
      val_313_b: r['313-B'] || null,
      created_by: state.user.id
    }));

    try {
      const { data, error } = await supabase.from('feed_reports').insert(rows);
      if(error) throw error;
      alert('Saved to cloud: ' + (data?.length || rows.length) + ' rows.');
    } catch(err){
      console.error(err);
      alert('Cloud save failed: ' + (err.message || JSON.stringify(err)));
    }
  });

  // rendering
  function render(){
    tableArea.innerHTML = '';
    if(!state.data.length){ empty.style.display='block'; reportDateDom.textContent='Report Generated on -'; refreshControls(); return; }
    empty.style.display='none';
    refreshControls();
    const now = new Date(); reportDateDom.textContent = 'Report Generated on ' + pad(now.getDate())+' '+monthNames[now.getMonth()]+' '+now.getFullYear();

    const groups = groupByDate(state.data);
    const container = document.createElement('div');

    Object.keys(groups).sort((a,b)=>dateToTimestamp(a)-dateToTimestamp(b)).forEach(date=>{
      const grp = groups[date];
      const box = document.createElement('div'); box.className='group';
      const gh = document.createElement('div'); gh.className='group-header';
      gh.innerHTML = `<div><strong>${date}</strong> <span class="tiny">(${grp.length} entries)</span></div>
                      <div class="group-totals tiny"></div>`;
      box.appendChild(gh);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>Farm</th><th>333</th><th>332</th><th>3331</th><th>330</th><th>313-A</th><th>313-B</th><th>Actions</th></tr>`;
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      grp.forEach((row,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(row.Farm)}</td>
                        <td>${displayVal(row['333'])}</td>
                        <td>${displayVal(row['332'])}</td>
                        <td>${displayVal(row['3331'])}</td>
                        <td>${displayVal(row['330'])}</td>
                        <td>${displayVal(row['313-A'])}</td>
                        <td>${displayVal(row['313-B'])}</td>
                        <td class="actions"></td>`;
        const actions = tr.querySelector('.actions');
        const globalIndex = state.data.findIndex(r=>r.Date===row.Date && r.Farm===row.Farm && r['333']===row['333'] && r['332']===row['332']);
        const editBtn = document.createElement('button'); editBtn.textContent='Edit'; editBtn.className='ghost';
        editBtn.addEventListener('click', ()=> openModalForEdit(globalIndex));
        actions.appendChild(editBtn);
        if(state.user && state.user.role==='admin'){
          const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger';
          delBtn.addEventListener('click', ()=> {
            if(!confirm('Delete this entry?')) return;
            const idx = state.data.findIndex(r=>r.Date===row.Date && r.Farm===row.Farm && r['333']===row['333'] && r['332']===row['332']);
            if(idx>=0) state.data.splice(idx,1);
            saveLocal(); render();
          });
          actions.appendChild(delBtn);
        }
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      const gt = groupTotals(grp);
      const tf = document.createElement('div');
      tf.className='tiny';
      tf.innerHTML = `Totals — 333: ${gt['333']||''} &nbsp;&nbsp; 332: ${gt['332']||''} &nbsp;&nbsp; 3331: ${gt['3331']||''} &nbsp;&nbsp; 330: ${gt['330']||''} &nbsp;&nbsp; 313-A: ${gt['313-A']||''} &nbsp;&nbsp; 313-B: ${gt['313-B']||''}`;
      box.appendChild(table);
      box.appendChild(tf);

      container.appendChild(box);
    });

    const grand = computeTotals();
    const grandBox = document.createElement('div'); grandBox.style.marginTop='8px';
    const gtbl = document.createElement('table'); gtbl.innerHTML = `<thead><tr><th style="width:220px">Grand Totals</th><th>333</th><th>332</th><th>3331</th><th>330</th><th>313-A</th><th>313-B</th></tr></thead>`;
    const gb = document.createElement('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td></td><td>${grand['333']||''}</td><td>${grand['332']||''}</td><td>${grand['3331']||''}</td><td>${grand['330']||''}</td><td>${grand['313-A']||''}</td><td>${grand['313-B']||''}</td>`;
    gb.appendChild(tr);
    gtbl.appendChild(gb);
    grandBox.appendChild(gtbl);
    container.appendChild(grandBox);

    tableArea.appendChild(container);
  }

  function groupByDate(arr){
    const g = {};
    arr.forEach(r=>{ if(!g[r.Date]) g[r.Date]=[]; g[r.Date].push(r); });
    return g;
  }
  function groupTotals(rows){
    const t={'333':0,'332':0,'3331':0,'330':0,'313-A':0,'313-B':0};
    rows.forEach(r=>{ Object.keys(t).forEach(k=> t[k] += (r[k]||0) ); });
    return t;
  }
  function computeTotals(){ return groupTotals(state.data); }
  function dateToTimestamp(display){
    const iso = displayToISO(display);
    if(iso) return new Date(iso).getTime();
    const d = new Date(display); return isNaN(d)?0:d.getTime();
  }
  function displayToISO(display){
    const m = display.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})$/);
    if(m){ const day=Number(m[1]), mon=monthNames.indexOf(m[2]), yr=Number(m[3]); if(mon>=0) return `${yr}-${String(mon+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; }
    if(/^\d{4}-\d{2}-\d{2}$/.test(display)) return display;
    return null;
  }

  function displayVal(v){ return (v===null||v===undefined)?'':v; }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function saveLocal(){ try{ localStorage.setItem('report_state_v1', JSON.stringify(state)); }catch(e){} }
  function loadLocal(){ try{ const raw = localStorage.getItem('report_state_v1'); if(!raw) return; const parsed = JSON.parse(raw); if(parsed && parsed.data) state = parsed; }catch(e){} }

  // init
  loadLocal();
  render();
  refreshControls();

  </script>
</body>
</html>
